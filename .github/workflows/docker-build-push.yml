name: Build & Push Container

on:
  push:
    branches: [main, ci/image-scanning]
    paths:
      - "bucket-list/**"
      - ".github/workflows/docker-build-push.yml"
      - "terraform/artifact-registry.tf"
      - "terraform/iam.tf"
  workflow_dispatch:

env:
  REGION: us-central1
  REPO: bucket-list
  IMAGE: bucket-list

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet

      - name: Build and push
        run: |
          IMAGE_URI="${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${REPO}/${IMAGE}"
          docker build -t "${IMAGE_URI}:${GITHUB_SHA::7}" -t "${IMAGE_URI}:latest" ./bucket-list
          docker push "${IMAGE_URI}:${GITHUB_SHA::7}"
          docker push "${IMAGE_URI}:latest"

      - name: Verify wizexercise.txt
        run: |
          IMAGE_URI="${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${REPO}/${IMAGE}"
          docker run --rm "${IMAGE_URI}:${GITHUB_SHA::7}" cat /wizexercise.txt

      - name: Vulnerability scan gate
        run: |
          IMAGE_URI="${REGION}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${REPO}/${IMAGE}:${GITHUB_SHA::7}"
          echo "Waiting for vulnerability scan on ${IMAGE_URI}..."

          for i in $(seq 1 30); do
            JSON=$(gcloud artifacts docker images describe "${IMAGE_URI}" \
              --show-package-vulnerability --format=json 2>/dev/null || echo "{}")
            TOTAL=$(echo "$JSON" | jq '[.package_vulnerability_summary.severity_summary // {} | to_entries[].value] | add // 0')
            if [ "$TOTAL" -gt 0 ] 2>/dev/null; then
              break
            fi
            echo "  Scan in progress... (attempt ${i}/30)"
            sleep 10
          done

          echo "=== Vulnerability Summary ==="
          echo "$JSON" | jq '.package_vulnerability_summary.severity_summary // "No results"'

          CRITICAL=$(echo "$JSON" | jq '.package_vulnerability_summary.severity_summary.CRITICAL // 0')
          echo "Critical: ${CRITICAL}"

          if [ "$CRITICAL" -gt 0 ] 2>/dev/null; then
            echo "::error::Image has ${CRITICAL} CRITICAL vulnerabilities â€” failing pipeline."
            exit 1
          fi
          echo "No critical vulnerabilities. Pipeline passed."
